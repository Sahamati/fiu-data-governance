# Sample: Confidential flow-based lending in the AA ecosystem

## Table of Contents
1. [Prerequisites](#Prerequisites)
1. [Building the service containers](#Building-the-service-containers)
1. [Building the cryptography sidecar container](#Building-the-cryptography-sidecar-container)
1. [Building the inmemory keyprovider sidecar container](#Building-the-inmemory-keyprovider-sidecar-container)
1. [Publishing the DEPA policy bundle to a container registry](#Publishing-the-DEPA-policy-bundle-to-a-container-registry)
1. [Deploying the sample using ACI Confidential Containers](#Deploying-the-sample-using-ACI-Confidential-Containers)
    1. [Install confidential computing extension for Azure CLI](#Install-confidential-computing-extension-for-Azure-CLI)
    1. [Configure and set environment variables](#Configure-and-set-environment-variables)
    1. [Deploy the CCRs](#Deploy-the-CCRs)
    1. [Run the workflow on ACI](#Run-the-workflow-on-ACI)
1. [Deploying and running the sample on AKS](#Deploying-and-running-the-sample-on-AKS)
    1. [Deploy the Certificate Registry (CR) to AKS](#Deploy-the-Certificate-Registry-(CR)-to-AKS)
    1. [Deploy the CCRs to AKS](#Deploy-the-CCRs-to-AKS)
    1. [Run the workflow on AKS](#Run-the-workflow-on-AKS)
    1. [Cleaning up the AKS deployment](#Cleaning-up-the-AKS-deployment)

This sample consists of 5 services that interact with each other to process a scoring request:

- Account Aggregator (AA)
- Financial Information User (FIU)
- Business Rule Engine (BRE)
- Statements Analysis (SA)
- Certificate Registry (CR)

The Account Aggregator (AA) and Financial Information User (FIU) services run locally on Docker
containers. They are considered _untrusted_ and are not part of the CCR. Note that for simplicity,
the AA is also simulating a Financial Information Provider (FIP) in this sample.

The Business Rule Engine (BRE) and Statements Analysis (SA) services are also considered
_untrusted_, but they _run inside a CCR_ deployed on Azure Container Instances (ACI) or Azure Kubernetes Service (AKS) cluster. The CCR deployment
ensures that these two services are sandboxed and adhere to the configured [ingress and egress
policies](policies).

Finally, the Certificate Registry (CR) service is also deployed on the same ACI or AKS cluster for
simplicity, but is trusted and runs outside of a CCR. This service mocks requests to Sahamati for
the purposes of verifying the signed consent.

There is also a client script that starts the workflow.

_Please note that all services in this sample are very basic (with certain logic hardcoded), as
their purpose is to just serve as an example of using CCRs, and not showing a production end-to-end
flow-based lending workflow._

## Prerequisites

If you have not already followed [the CCR setup instructions](../../docs/setup.md), please do so
before proceeding.

## Building the service containers

Build the service containers run the following script in `powershell`:
```
./build/build-depa-services.ps1
```

## Building the cryptography sidecar container

This sample uses the Sahamati `rahasya` crypto container that is available
[here](https://github.com/Sahamati/rahasya/tree/V1.2).

If you have not done so already, you must first sync and update the `rahasya`
[submodule](..\external\rahasya), as follows:
```
git submodule sync --recursive
git submodule update --init --recursive
```

You are now ready to build the crypto sidecar container by running the following script in
`powershell`:
```
./build/build-crypto-sidecar.ps1
```

Next, tag the image and push it to ACR from `powershell`:
```powershell
docker tag crypto-sidecar:latest $acrLoginServer/crypto-sidecar:latest
docker push $acrLoginServer/crypto-sidecar:latest
```
## Building the inmemory keyprovider sidecar container

This sample uses an inmemory key provider container to store the private key generated by the
`/api/ccr/key` API that is later retreived during the `/api/ccr/process` API invocation. You can build
 the container by running the following script in `powershell`:
```
./build/build-inmemory-keyprovider.ps1
```

Next, tag the image and push it to ACR from `powershell`:
```powershell
docker tag inmemory-keyprovider:latest $acrLoginServer/inmemory-keyprovider:latest
docker push $acrLoginServer/inmemory-keyprovider:latest
```
## Publish containers

Tag the container images built using the previous steps and push them to [ACR](https://azure.microsoft.com/services/container-registry/):
```powershell
$acrLoginServer="<ACR_LOGIN_SERVER>"
docker login $acrLoginServer
./build/push-depa-containers.ps1
```

## Publishing the DEPA policy bundle to a container registry

The rego policies are loaded into OPA by supplying a policy bundle that is hosted in a container registry.

First login to the registry using `docker` in `powershell`:
```powershell
$acrLoginServer="<ACR_LOGIN_SERVER>"
docker login $acrLoginServer
```

Next, publish the bundle `powershell`:
```powershell
./build/publish-depa-policies-bundle.ps1 -registryUrl $acrLoginServer
```

## Deploying the sample using ACI Confidential Containers
Azure Container Instances (ACI) enables deployment of containers within hardware-isolated virtual machines (based on SEV-SNP technology). This mode of deployment isolates the containers from both cloud and guest administrators, and enables remote users to attest container deployments. 

ACI confidential containers can be used to deploy Confidential Clean Rooms with the following limitations. 
1. Not all features required for sandboxing application containers are available in ACI. 
2. ACI confidential containers are currently in preview. 

Login to the subscription using Azure CLI in `powershell`:
```sh
$SUBSCRIPTION="<Your Azure subscription>"

az login
az account set --subscription $SUBSCRIPTION
```

### Install confidential computing extension for Azure CLI

Install the Azure CLI confidential container extension:
```sh
az extension add confcom -y
```

### Configure and set environment variables

Edit the ```set-env.ps1``` file under ```./samples/aa-flow-based-lending/deployment/aci```, updating the resource group you want to use, the container registry where the containers are stored, and container registry username and password. You may also provide the DNS names for the services you are going to deploy. Finally, set the environment variables as follows. 

```sh
set-env.ps1 
```
### Deploy the CCRs 

You can now deploy the CCRs to ACI by running
the following commands in `powershell`:
```sh
./deploy-certificate-registry.ps1
./deploy-statement-analysis.ps1
./deploy-business-rule-engine.ps1
```

### Run the workflow on ACI

First, run the AA, FIU and crypto client containers locally using Docker compose:
```sh
docker compose -f ./samples/aa-flow-based-lending/docker-compose.yml up
```

You can now invoke the following client python script, which setups the initial state of the AA and
FIU containers, and then runs the workflow:
```sh
python3 ./initiate-credit-request.ps1
```

## Deploying and running the sample on AKS
The CCR can also be deployed using Azure Kubernetes Service but without confidential computing support. 

### Create an AKS cluster
Create an AKS cluster using the following [instructions](../../docs/azure/aks.md). 

### Deploy the Certificate Registry (CR) to AKS

Deploy the CR service to AKS by running the following script in `powershell`:
```sh
$acrLoginServer="<ACR_LOGIN_SERVER>" # Where the container images are published eg "foo.azurecr.io"
./samples/aa-flow-based-lending/deploy-registry.ps1 -registryUrl $acrLoginServer
```

**Note:** Running the above script will replace any registry that has already been deployed.

### Deploy the CCRs to AKS

Assuming you have completed the instructions above, you can now deploy the CCRs to AKS by running
the following script in `powershell`:
```sh
$acrLoginServer="<ACR_LOGIN_SERVER>" # Where the container images are published eg "foo.azurecr.io"
./samples/aa-flow-based-lending/deploy-ccr.ps1 -registryUrl $acrLoginServer
```

**Note:** Running the above script replaces any already deployed CCRs, as well as any installed
configuration and policy files.

Wait until the pod(s) have been successfully deployed. To find out, run the following command:
```sh
kubectl get pods --watch
```
Once the status of the pod(s) changes to `Running`, do `ctrl+c` and you are good to go!

To see the business logic container logs, run:
```sh
kubectl logs -l app=statement-analysis -c statement-analysis-service --tail=-1
kubectl logs -l app=business-rule-engine -c business-rule-engine-service --tail=-1
```

To see the CCR proxy container logs, run:
```sh
kubectl logs -l app=statement-analysis -c ccr-proxy --tail=-1
kubectl logs -l app=business-rule-engine -c ccr-proxy --tail=-1
```

To see the CCR sidecar container logs, run:
```sh
kubectl logs -l app=statement-analysis -c ccr-sidecar --tail=-1
kubectl logs -l app=business-rule-engine -c ccr-sidecar --tail=-1
```

To see the CCR policy engine container logs, run:
```sh
kubectl logs -l app=statement-analysis -c policy-engine --tail=-1
kubectl logs -l app=business-rule-engine -c policy-engine --tail=-1
```

To see the CCR crypto sidecar container logs, run:
```sh
kubectl logs -l app=statement-analysis -c crypto-sidecar --tail=-1
kubectl logs -l app=business-rule-engine -c crypto-sidecar --tail=-1
```

To see the certificate registry (CR) container logs, run:
```sh
kubectl logs -l app=certificate-registry --tail=-1
```

### Run the workflow on AKS

First, run the AA, FIU and crypto client containers locally using Docker compose:
```sh
docker compose -f ./samples/aa-flow-based-lending/docker-compose.yml up
```

You can now invoke the following client python script, which setups the initial state of the AA and
FIU containers, and then runs the workflow:
```sh
$breIP=(kubectl get svc business-rule-engine -o json | ConvertFrom-Json).status.loadBalancer.ingress.ip
$crIP=(kubectl get svc certificate-registry -o json | ConvertFrom-Json).status.loadBalancer.ingress.ip
python3 samples/aa-flow-based-lending/client.py --fi samples/aa-flow-based-lending/data/transactions.json \
  --consent samples/aa-flow-based-lending/data/consent.json --bre-url "http://$($breIP):80/" --cr-url "http://$($crIP):80/"
```

To get the logs from the local containers, run:
```sh
docker compose -f ./samples/aa-flow-based-lending/docker-compose.yml logs --since 1m
```
where `1m` can be replaced with any time period.

If you want to print the logs from a single container only, add the name of the container to the end
of the above command: `financial-information-user` or `account-aggregator`.

### Cleaning up the AKS deployment

To clean up the deployment on the AKS, run the following two scripts in `powershell`:
```
./samples/aa-flow-based-lending/deploy-registry.ps1 -remove
./samples/aa-flow-based-lending/deploy-ccr.ps1 -remove
```

This will remove the deployed CCR services and registry, as well as remove any installed
CCR configuration and policy files.
